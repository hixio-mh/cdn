/**
  * v1.0.117 generated on: Wed Aug 10 2016 23:20:10 GMT+0000 (UTC)
  * Copyright (c) 2014-2016, Ecor Ventures LLC. All Rights Reserved. See LICENSE (BSD).
  */
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Store=function(e){function t(e){_classCallCheck(this,t),e=e||{};var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));Object.defineProperties(i,{model:NGN["const"](e.model||null),_data:NGN["private"]([]),_filters:NGN["private"]([]),_index:NGN["private"](e.index||[]),_created:NGN["private"]([]),_deleted:NGN["private"]([]),_loading:NGN["private"](!1),_softarchive:NGN["private"]([]),proxy:NGN["private"](null),allowDuplicates:NGN["public"](NGN.coalesce(e.allowDuplicates,!0)),errorOnDuplicate:NGN["const"](NGN.coalesce(e.errorOnDuplicate,e.allowDuplicates,!0)),autoRemoveExpiredRecords:NGN.privateconst(NGN.coalesce(e.autoRemoveExpiredRecords,!0)),softDelete:NGN.privateconst(NGN.coalesce(e.softDelete,!1)),softDeleteTtl:NGN["private"](NGN.coalesce(e.softDeleteTtl,-1))});var r={};i._index.forEach(function(e){r[e]=[]}),i._index=r;var n=["record.duplicate","record.create","record.update","record.delete","record.restored","record.purged","record.move","record.invalid","record.valid","clear","filter.create","filter.delete","index.create","index.delete"];return NGN.BUS&&n.forEach(function(e){i.on(e,function(){var t=NGN.slice(arguments);t.shift(),t.push(this),NGN.BUS.emit(e,t)})}),i}return _inherits(t,e),_createClass(t,[{key:"add",value:function(e,t){var i=void 0;if(e instanceof NGN.DATA.Entity)i=e;else{try{e=JSON.parse(e)}catch(r){}if("object"!==("undefined"==typeof e?"undefined":_typeof(e)))throw new Error("Cannot add a non-object record.");i=this.model?new this.model(e):e}i.hasOwnProperty("_store")&&(i._store=this);var n=this.isDuplicate(i);if(!n||(this.emit("record.duplicate",i),this.allowDuplicates))return this.listen(i),this.applyIndices(i,this._data.length),this._data.push(i),!this._loading&&this._created.indexOf(i)<0&&this._created.push(i),NGN.coalesce(t,!1)||this.emit("record.create",i),i.valid||this.emit("record.invalid",i),i;if(this.errorOnDuplicate)throw new Error("Cannot add duplicate record (allowDuplicates = false).")}},{key:"insertBefore",value:function(e,t){var i=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];return this.insert(e,t,i,"before")}},{key:"insertAfter",value:function(e,t){var i=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];return this.insert(e+1,t,i,"after")}},{key:"insert",value:function(e,t){var i=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],r=arguments.length<=3||void 0===arguments[3]?"after":arguments[3],n=this.add(t,!0);return n&&(this.move(this._data.length-1,e,r,!1),i||this.emit("record.create",n)),n}},{key:"isDuplicate",value:function(e){return!(this._data.indexOf(e)>=0)&&this._data.filter(function(t){return t.checksum===e.checksum}).length>0}},{key:"listen",value:function(e){var t=this;e.on("field.update",function(i){t.updateIndice(i.field,i.old,i["new"],t._data.indexOf(e)),t.emit("record.update",e,i)}),e.on("field.delete",function(i){t.updateIndice(i.field,i.old,void 0,t._data.indexOf(e)),t.emit("record.update",e,i)}),e.on("field.invalid",function(){t.emit("record.invalid",e)}),e.on("field.valid",function(){t.emit("record.valid",e)}),e.on("expired",function(){e.expired&&(t.emit("record.expired",e),t.autoRemoveExpiredRecords&&t.remove(e))})}},{key:"bulk",value:function(e,t){var i=this;this._loading=!0,t.forEach(function(e){i.add(e,!0)}),this._loading=!1,this._deleted=[],this._created=[],this.emit(e||"load")}},{key:"load",value:function(){var e=Array.isArray(arguments[0])?arguments[0]:NGN.slice(arguments);this.bulk("load",e)}},{key:"reload",value:function(e){this.clear();var t=Array.isArray(arguments[0])?arguments[0]:NGN.slice(arguments);this.bulk("reload",t)}},{key:"indexOf",value:function(e){return"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(e instanceof NGN.DATA.Entity||e.checksum)?this._data.findIndex(function(t){return t.checksum===e.checksum}):-1}},{key:"contains",value:function(e){return this.indexOf(e)>=0}},{key:"remove",value:function(e,t){var i=this,r=[],n=void 0;if("number"==typeof e?n=e:e&&e.checksum&&null!==e.checksum||e instanceof NGN.DATA.Model?n=this.indexOf(e):!function(){var t=new i.model(e,(!0));n=i._data.findIndex(function(e){return e.checksum===t.checksum})}(),n<0)throw new Error("Record removal failed (record not found at index "+(n||"").toString()+").");if(r=this._data.splice(n,1),r.length>0){if(r=r[0],this.unapplyIndices(n),this.softDelete&&(this.softDeleteTtl>=0&&!function(){var e=r.checksum;r.once("expired",function(){i.purgeDeletedRecord(e)}),r.expires=i.softDeleteTtl}(),this._softarchive.push(r)),!this._loading){var o=this._created.indexOf(r);o>=0?o>=0&&this._created.splice(o,1):this._deleted.indexOf(r)<0&&this._deleted.push(r)}return NGN.coalesce(t,!1)||this.emit("record.delete",r,n),r}return null}},{key:"findArchivedRecord",value:function(e){var t=void 0,i=this._softarchive.filter(function(i,r){if(i.checksum===e)return t=r,!0});if(1!==i.length){var r=void 0;try{r=NGN.stack.pop().path}catch(n){r="Unknown"}return console.warn("Cannot purge record. %c"+i.length+" records found%c. Source: %c"+r,NGN.css,"",NGN.css),null}return{index:t,record:i[0]}}},{key:"purgeDeletedRecord",value:function(e){var t=this.findArchivedRecord(e);return null===t?null:(this._softarchive.splice(t.index,1),this.emit("record.purged",t.record),t.record)}},{key:"restore",value:function(e){var t=this.findArchivedRecord(e);return null===t?null:(t.record.removeAllListeners("expired"),t.record.expires=this.softDeleteTtl,this.add(t.record,!0),this._softarchive[t.index].removeAllListeners("expired"),this._softarchive.splice(t.index,1),this.emit("record.restored",t.record),t.record)}},{key:"clear",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]||arguments[0];t?this._softarchive=[]:this._softarchive=this._data,this._data=[],Object.keys(this._index).forEach(function(t){e._index[t]=[]}),this.emit("clear")}},{key:"find",value:function(e,t){var i=this;if(0===this._data.length)return[];var r=[],n=function(){switch("undefined"==typeof e?"undefined":_typeof(e)){case"function":r=i._data.filter(e);break;case"number":r=e<0||e>=i._data.length?null:i._data[e];break;case"string":var t=i.getIndices(i._data[0].idAttribute,e.trim());if(null!==t&&t.length>0)return t.forEach(function(e){r.push(i._data[e])}),{v:r};var n=i._data.filter(function(t){return(t[t.idAttribute]||"").toString().trim()===e.trim()});r=0===n.length?null:n[0];break;case"object":if(e instanceof NGN.DATA.Model)return i.contains(e)?{v:e}:{v:null};var o=[],c=[],s=Object.keys(e);s.forEach(function(t){var r=i.getIndices(t,e[t]);r?o=o.concat(r||[]):null!==t&&c.push(t)}),o.filter(function(e,t){return o.indexOf(e)===t}),c.length>0&&(r=i._data.filter(function(t,i){if(o.indexOf(i)>=0)return!1;for(var r=0;r<c.length;r++)if(t[c[r]]!==e[c[r]])return!1;return!0})),r=r.concat(o.map(function(e){return i._data[e]})).filter(function(t){for(var i=0;i<s.length;i++)if(e[s[i]]!==t[s[i]])return!1;return!0});break;default:r=i._data}}();return"object"===("undefined"==typeof n?"undefined":_typeof(n))?n.v:null===r?null:(NGN.coalesce(t,!1)||this.applyFilters(r instanceof Array?r:[r]),r)}},{key:"applyFilters",value:function(e){return 0===this._filters.length?e:(this._filters.forEach(function(t){e=e.filter(t)}),e)}},{key:"addFilter",value:function(e){this._filters.push(e),this.emit("filter.create",e)}},{key:"removeFilter",value:function(e,t){t=NGN.coalesce(t,!1);var i=[];i="number"==typeof e?this._filters.splice(e,1):this._filters.splice(this._filters.indexOf(e),1),i.length>0&&!t&&this.emit("filter.delete",i[0])}},{key:"clearFilters",value:function(e){if(e=NGN.coalesce(e,!1))return void(this._filters=[]);for(;this._filters.length>0;)this.emit("filter.delete",this._filters.pop())}},{key:"deduplicate",value:function(e){var t=this;e=NGN.coalesce(e,!0);var i=this.data.map(function(e){return JSON.stringify(e)}),r=[];i.forEach(function(e,n){i.indexOf(e)<n&&r.push(t.find(n))}),r.forEach(function(e){t.remove(e)})}},{key:"sort",value:function(e){var t=this;"function"==typeof e?this.records.sort(e):"object"===("undefined"==typeof e?"undefined":_typeof(e))&&!function(){var i=Object.keys(e);t._data.sort(function(t,r){for(var n=0;n<i.length;n++){if(t.hasOwnProperty(i[n])&&!r.hasOwnProperty(i[n]))return 1;if(!t.hasOwnProperty(i[n])&&r.hasOwnProperty(i[n]))return-1;if(t[i[n]]!==r[i[n]])switch(e[i[n]].toString().trim().toLowerCase()){case"asc":return _typeof(t.fields[i[n]])?t[i[n]].localeCompare(r[i[n]]):t[i[n]]>r[i[n]]?1:-1;case"desc":return t[i[n]]<r[i[n]]?1:-1;default:return"function"==typeof e[i[n]]?e[i[n]](t,r):0}}return 0})}(),this.reindex()}},{key:"createIndex",value:function(e,t){this.model.hasOwnProperty(e)||console.warn("The store's model does not contain a data field called %c"+e+"%c.",NGN.css,"");var i=this._index.hasOwnProperty(e);this._index[e]=this._index[e]||[],NGN.coalesce(t,!1)||i||this.emit("index.created",{field:e,store:this})}},{key:"deleteIndex",value:function(e,t){this._index.hasOwnProperty(e)&&(delete this._index[e],NGN.coalesce(t,!1)||this.emit("index.created",{field:e,store:this}))}},{key:"clearIndices",value:function(){var e=this;Object.keys(this._index).forEach(function(t){e._index[t]=[]})}},{key:"deleteIndexes",value:function(e){var t=this;e=NGN.coalesce(e,!0),Object.keys(this._index).forEach(function(i){t.deleteIndex(i,e)})}},{key:"applyIndices",value:function(e,t){var i=this,r=Object.keys(this._index);0!==r.length&&r.forEach(function(r){if(e.hasOwnProperty(r)){for(var n=i._index[r],o=0;o<n.length;o++)if(n[o][0]===e[r])return void i._index[r][o].push(t);i._index[r].push([e[r],t])}})}},{key:"unapplyIndices",value:function(e){var t=this;Object.keys(this._index).forEach(function(i){var r=t._index[i].indexOf(e);r>=0&&t._index[i].splice(r,1)})}},{key:"updateIndice",value:function(e,t,i,r){if(this._index.hasOwnProperty(e)&&t!==i)for(var n=0,o=0;o<this._index[e].length;o++){var c=this._index[e][o][0];if(c===t?(this._index[e][o].splice(this._index[e][o].indexOf(r),1),n++):void 0===i?n++:c===i&&(this._index[e][o].push(r),this._index[e][o].shift(),this._index[e][o].sort(),this._index[e][o].unshift(c),n++),2===n)return}}},{key:"getIndices",value:function(e,t){if(!this._index.hasOwnProperty(e))return null;var i=this._index[e].filter(function(e){return e.length>0&&e[0]===t});return 1===i.length?(i[0].shift(),i[0]):[]}},{key:"move",value:function(e,t){var i=!(arguments.length<=2||void 0===arguments[2])&&arguments[2];return void 0===e?void console.warn("Cannot move record. No source specified."):void 0===t?void console.warn("Cannot move record. No target specified."):(e=this.getRecordIndex(e),t=this.getRecordIndex(t),void(e!==t&&(this._data.splice(t,0,this._data.splice(e,1)[0]),i||this.emit("record.move",{oldIndex:e,newIndex:t,record:this._data[t]}),this.reindex())))}},{key:"getRecordIndex",value:function(e){if(void 0===e)return console.warn("No argument passed to getRecordIndex()."),null;if("number"==typeof e)return e<0||e>=this._data.length?(console.warn("%c"+e+"%c out of bounds.",NGN.css,""),null):e;if("string"==typeof e){var t=e;if(e=this.find(t),!e)return console.warn("%c"+t+"%c does not exist or cannot be found in the store.",NGN.css,""),null}return this.indexOf(e)}},{key:"reindex",value:function(){var e=this;this.clearIndices(),this._data.forEach(function(t,i){e.applyIndices(t,i)})}},{key:"data",get:function(){return this._data.map(function(e){return e.data})}},{key:"records",get:function(){return this.applyFilters(this._data)}},{key:"recordCount",get:function(){return this.applyFilters(this._data).length}},{key:"filtered",get:function(){var e=this.records;return this._data.filter(function(t){return 0===e.filter(function(e){return e.checksum===t.checksum}).length})}},{key:"first",get:function(){return 0===this.records.length?null:this.records[0]}},{key:"last",get:function(){return 0===this.records.length?null:this.records[this.records.length-1]}}]),t}(NGN.EventEmitter);NGN.DATA.Store=Store;
//# sourceMappingURL=https://ngnjs.github.io/cdn/assets/chassis-lib/sourcemaps/1.0.117/store.min.js.map