/**
  * v1.0.88 generated on: Thu Jul 07 2016 17:41:09 GMT+0000 (UTC)
  * Copyright (c) 2014-2016, Ecor Ventures LLC. All Rights Reserved. See LICENSE (BSD).
  */
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Store=function(e){function t(e){_classCallCheck(this,t),e=e||{};var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));Object.defineProperties(n,{model:NGN["const"](e.model||null),_data:NGN["private"]([]),_filters:NGN["private"]([]),_index:NGN["private"](e.index||[]),_created:NGN["private"]([]),_deleted:NGN["private"]([]),_loading:NGN["private"](!1),proxy:NGN["private"](null),allowDuplicates:NGN["public"](NGN.coalesce(e.allowDuplicates,!0)),errorOnDuplicate:NGN["const"](NGN.coalesce(e.errorOnDuplicate,e.allowDuplicates,!0))});var i={};n._index.forEach(function(e){i[e]=[]}),n._index=i;var r=["record.duplicate","record.create","record.update","record.delete","clear","filter.create","filter.delete","index.create","index.delete"];return NGN.BUS&&!function(){var e=n;r.forEach(function(t){e.on(t,function(){var n=NGN.slice(arguments);n.shift(),n.push(e),NGN.BUS.emit(t,n)})})}(),n}return _inherits(t,e),_createClass(t,[{key:"add",value:function(e,t){var n=void 0,i=this;if(e instanceof NGN.DATA.Entity)n=e;else{try{e=JSON.parse(e)}catch(r){}if("object"!==("undefined"==typeof e?"undefined":_typeof(e)))throw new Error("Cannot add a non-object record.");n=this.model?new this.model(e):e}n.hasOwnProperty("_store")&&(n._store=i);var a=this.isDuplicate(n);if(!a||(this.emit("record.duplicate",n),this.allowDuplicates))this.listen(n),this.applyIndices(n,this._data.length),this._data.push(n),!this._loading&&this._created.indexOf(n)<0&&this._created.push(n),!NGN.coalesce(t,!1)&&this.emit("record.create",n);else if(this.errorOnDuplicate)throw new Error("Cannot add duplicate record (allowDuplicates = false).")}},{key:"isDuplicate",value:function(e){return!(this._data.indexOf(e)>=0)&&this._data.filter(function(t){return t.checksum===e.checksum}).length>0}},{key:"listen",value:function(e){var t=this;e.on("field.update",function(n){t.updateIndice(n.field,n.old,n["new"],t._data.indexOf(e)),t.emit("record.update",e,n)}),e.on("field.delete",function(n){t.updateIndice(n.field,n.old,void 0,t._data.indexOf(e)),t.emit("record.update",e,n)})}},{key:"bulk",value:function(e,t){this._loading=!0;var n=this;t.forEach(function(e){n.add(e,!0)}),this._loading=!1,this._deleted=[],this._created=[],this.emit(e||"load")}},{key:"load",value:function(){var e=Array.isArray(arguments[0])?arguments[0]:NGN.slice(arguments);this.bulk("load",e)}},{key:"reload",value:function(e){this.clear();var t=Array.isArray(arguments[0])?arguments[0]:NGN.slice(arguments);this.bulk("reload",t)}},{key:"indexOf",value:function(e){return"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(e instanceof NGN.DATA.Entity||e.checksum)?this._data.findIndex(function(t){return t.checksum===e.checksum}):-1}},{key:"contains",value:function(e){return this.indexOf(e)>=0}},{key:"remove",value:function(e,t){var n=this,i=[],r=void 0;if("number"==typeof e?r=e:e&&e.checksum&&null!==e.checksum||e instanceof NGN.DATA.Model?r=this.indexOf(e):!function(){var t=new n.model(e,(!0));r=n._data.findIndex(function(e){return e.checksum===t.checksum})}(),r<0)throw new Error("Record removal failed (record not found at index "+(r||"").toString()+").");if(i=this._data.splice(r,1),i.length>0){if(i=i[0],this.unapplyIndices(r),!this._loading){var a=this._created.indexOf(i);a>=0?a>=0&&this._created.splice(a,1):this._deleted.indexOf(i)<0&&this._deleted.push(i)}NGN.coalesce(t,!1)||this.emit("record.delete",i)}}},{key:"clear",value:function(){this._data=[];var e=this;Object.keys(this._index).forEach(function(t){e._index[t]=[]}),this.emit("clear")}},{key:"find",value:function(e,t){var n=this;if(0===this._data.length)return[];var i=[],r=this,a=function(){switch("undefined"==typeof e?"undefined":_typeof(e)){case"function":i=n._data.filter(e);break;case"number":i=e<0||e>=n._data.length?null:n._data[e];break;case"string":var t=n.getIndices(n._data[0].idAttribute,e.trim());if(null!==t&&t.length>0)return t.forEach(function(e){i.push(r._data[e])}),{v:i};var a=n._data.filter(function(t){return(t[t.idAttribute]||"").toString().trim()===e.trim()});i=0===a.length?null:a[0];break;case"object":if(e instanceof NGN.DATA.Model)return n.contains(e)?{v:e}:{v:null};var o=[],c=[],s=Object.keys(e);s.forEach(function(t){var n=r.getIndices(t,e[t]);n?o=o.concat(n||[]):null!==t&&c.push(t)}),o.filter(function(e,t){return o.indexOf(e)===t}),c.length>0&&(i=n._data.filter(function(t,n){if(o.indexOf(n)>=0)return!1;for(var i=0;i<c.length;i++)if(t[c[i]]!==e[c[i]])return!1;return!0})),i=i.concat(o.map(function(e){return r._data[e]})).filter(function(t){for(var n=0;n<s.length;n++)if(e[s[n]]!==t[s[n]])return!1;return!0});break;default:i=n._data}}();return"object"===("undefined"==typeof a?"undefined":_typeof(a))?a.v:null===i?null:(NGN.coalesce(t,!1)||this.applyFilters(i instanceof Array?i:[i]),i)}},{key:"applyFilters",value:function(e){return 0===this._filters.length?e:(this._filters.forEach(function(t){e=e.filter(t)}),e)}},{key:"addFilter",value:function(e){this._filters.push(e),this.emit("filter.create",e)}},{key:"removeFilter",value:function(e,t){t=NGN.coalesce(t,!1);var n=[];n="number"==typeof e?this._filters.splice(e,1):this._filters.splice(this._filters.indexOf(e),1),n.length>0&&!t&&this.emit("filter.delete",n[0])}},{key:"clearFilters",value:function(e){if(e=NGN.coalesce(e,!1))return void(this._filters=[]);for(var t=this;this._filters.length>0;)t.emit("filter.delete",this._filters.pop())}},{key:"deduplicate",value:function(e){e=NGN.coalesce(e,!0);var t=this.data.map(function(e){return JSON.stringify(e)}),n=[],i=this;t.forEach(function(e,r){t.indexOf(e)<r&&n.push(i.find(r))}),n.forEach(function(e){i.remove(e)})}},{key:"sort",value:function(e){var t=this;"function"==typeof e?this.records.sort(e):"object"===("undefined"==typeof e?"undefined":_typeof(e))&&!function(){var n=Object.keys(e);t.records.sort(function(t,i){for(var r=0;r<n.length;r++){if(t.hasOwnProperty(n[r])&&!i.hasOwnProperty(n[r]))return 1;if(!t.hasOwnProperty(n[r])&&i.hasOwnProperty(n[r]))return-1;if(t[n[r]]!==i[n[r]])switch(e[n[r]].toString().trim().toLowerCase()){case"asc":return t[n[r]]>i[n[r]]?1:-1;case"desc":return t[n[r]]<i[n[r]]?1:-1;default:return"function"==typeof e[n[r]]?e[n[r]](t,i):0}}return 0})}(),this.reindex()}},{key:"createIndex",value:function(e,t){this.model.hasOwnProperty(e)||console.warn("The store's model does not contain a data field called "+e+".");var n=this._index.hasOwnProperty(e);this._index[e]=this._index[e]||[],NGN.coalesce(t,!1)||n||this.emit("index.created",{field:e,store:this})}},{key:"deleteIndex",value:function(e,t){this._index.hasOwnProperty(e)&&(delete this._index[e],NGN.coalesce(t,!1)||this.emit("index.created",{field:e,store:this}))}},{key:"clearIndices",value:function(){var e=this;Object.keys(this._index).forEach(function(t){e._index[t]=[]})}},{key:"deleteIndexes",value:function(e){e=NGN.coalesce(e,!0);var t=this;Object.keys(this._index).forEach(function(n){t.deleteIndex(n,e)})}},{key:"applyIndices",value:function(e,t){var n=Object.keys(this._index);if(0!==n.length){var i=this;n.forEach(function(n){if(e.hasOwnProperty(n)){for(var r=i._index[n],a=0;a<r.length;a++)if(r[a][0]===e[n])return void i._index[n][a].push(t);i._index[n].push([e[n],t])}})}}},{key:"unapplyIndices",value:function(e){var t=this;Object.keys(this._index).forEach(function(n){var i=t._index[n].indexOf(e);i>=0&&t._index[n].splice(i,1)})}},{key:"updateIndice",value:function(e,t,n,i){if(this._index.hasOwnProperty(e)&&t!==n)for(var r=0,a=this,o=0;o<a._index[e].length;o++){var c=a._index[e][o][0];if(c===t?(a._index[e][o].splice(a._index[e][o].indexOf(i),1),r++):void 0===n?r++:c===n&&(a._index[e][o].push(i),a._index[e][o].shift(),a._index[e][o].sort(),a._index[e][o].unshift(c),r++),2===r)return}}},{key:"getIndices",value:function(e,t){if(!this._index.hasOwnProperty(e))return null;var n=this._index[e].filter(function(e){return e.length>0&&e[0]===t});return 1===n.length?(n[0].shift(),n[0]):[]}},{key:"reindex",value:function(){this.clearIndices();var e=this;this._data.forEach(function(t,n){e.applyIndices(t,n)})}},{key:"data",get:function(){return this._data.map(function(e){return e.data})}},{key:"records",get:function(){return this.applyFilters(this._data)}},{key:"recordCount",get:function(){return this.applyFilters(this._data).length}},{key:"filtered",get:function(){var e=this.records;return this._data.filter(function(t){return 0===e.filter(function(e){return e.checksum===t.checksum}).length})}}]),t}(NGN.EventEmitter);NGN.DATA.Store=Store;
//# sourceMappingURL=https://ngnjs.github.io/cdn/assets/chassis-lib/1.0.88/sourcemaps/store.min.js.map