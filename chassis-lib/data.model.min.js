/**
  * v1.0.113 generated on: Mon Aug 08 2016 00:22:05 GMT+0000 (UTC)
  * Copyright (c) 2014-2016, Ecor Ventures LLC. All Rights Reserved. See LICENSE (BSD).
  */
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),Model=function(_NGN$EventEmitter){function Model(e){_classCallCheck(this,Model),e=e||{};var t=_possibleConstructorReturn(this,Object.getPrototypeOf(Model).call(this)),i=t;Object.defineProperties(t,{idAttribute:NGN.privateconst(e.idAttribute||"id"),fields:NGN["private"](e.fields||{id:{required:!0,type:String,"default":e.id||null}}),joins:NGN["private"](e.relationships||{}),virtuals:NGN["private"](e.virtuals||{}),validators:NGN["private"]({}),validation:NGN["public"](NGN.coalesce(e.validation,!0)),isNew:NGN["private"](!0),isDestroyed:NGN["private"](!1),oid:NGN["private"](e[t.idAttribute]||null),autoid:NGN["public"](NGN.coalesce(e.autoid,!1)),benchmark:NGN["private"](null),expiration:NGN["private"](null),expirationTimeout:NGN["private"](null),hasExpired:NGN["private"](!1),ignoreTTL:NGN["private"](!1),createDate:NGN.privateconst(Date.now()),setUnmodified:NGN.privateconst(function(){this.benchmark=this.checksum,this.changelog=[]}),allowInvalidSave:NGN["private"](NGN.coalesce(e.allowInvalidSave,!1)),disableDataValidation:NGN["private"](NGN.coalesce(e.disableDataValidation,!1)),invalidDataAttributes:NGN["private"]([]),initialDataAttributes:NGN["private"]([]),changelog:NGN["private"]([]),_nativeValidators:NGN.privateconst({min:function(e,t){return"array"===NGN["typeof"](t)?t.length>=e:"number"===NGN["typeof"](t)?t>=e:"string"===NGN["typeof"](t)?t.trim().length>=e:"date"===NGN["typeof"](t)&&t.parse()>=e.parse()},max:function(e,t){return"array"===NGN["typeof"](t)?t.length<=e:"number"===NGN["typeof"](t)?t<=e:"string"===NGN["typeof"](t)?t.trim().length<=e:"date"===NGN["typeof"](t)&&t.parse()<=e.parse()},"enum":function(e,t){return e.indexOf(t)>=0},required:function(e,t){return i.hasOwnProperty(e)&&null!==i[t]}}),_dataMap:NGN["private"](e.dataMap||null),_reverseDataMap:NGN["public"](null),raw:NGN["private"]({}),rawjoins:NGN["private"]({}),_store:NGN["private"](null)});var a=t.datafields.concat(t.virtualdatafields).concat(t.relationships).filter(function(e,t,i){return i.indexOf(e)!==t});if(a.length>0)throw new Error("Duplicate field names exist: "+a.join(", ")+". Unique fieldnames are required for data fields, virtuals, and relationship fields.");t.fields.hasOwnProperty("id")||(e.fields.id={required:!0,type:String,"default":e.id||null}),Object.keys(t.fields).forEach(function(e){"object"!==_typeof(i.fields[e])&&null!==i.fields[e]&&(i.fields[e]={required:!0,type:i.fields[e],"default":null,name:e}),i.addField(e,!0)}),Object.keys(t.virtuals).forEach(function(e){Object.defineProperty(i,e,NGN.get(function(){return i.virtuals[e].apply(i)}))}),Object.keys(t.joins).forEach(function(e){i.addRelationshipField(e,i.joins[e],!0)});var r=["field.update","field.create","field.remove","field.invalid","validator.add","validator.remove","relationship.create","relationship.remove","expired"];return NGN.BUS&&r.forEach(function(e){i.on(e,function(){var t=NGN.slice(arguments);t.push(i),t.unshift(e),NGN.BUS.emit.apply(NGN.BUS,t)})}),e.hasOwnProperty("expires")&&(t.expires=e.expires),t}return _inherits(Model,_NGN$EventEmitter),_createClass(Model,[{key:"expire",value:function(e){if(!this.expired)return e?void(this.expires=e):void(this.ignoreTTL||(this.hasExpired=!0,clearTimeout(this.expirationTimeout),this.emit("expired",this)))}},{key:"disableExpiration",value:function(){this.expires=-1}},{key:"addValidator",value:function(e,t){if(!this.hasOwnProperty(e))return void console.warn("No validator could be create for %c"+e+"%c. It is not an attribute of %c"+this.type+"%c.",NGN.css,"",NGN.css,"");switch("undefined"==typeof t?"undefined":_typeof(t)){case"function":this.validators[e]=this.validators[e]||[],this.validators[e].push(t),this.emit("validator.add",e);break;case"object":Array.isArray(t)?(this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return t.indexOf(e)>=0}),this.emit("validator.add",e)):t.test?(this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return t.test(e)}),this.emit("validator.add",e)):console.warn("No validator could be created for %c"+e+"%c. The validator appears to be invalid.",NGN.css,"");break;case"string":case"number":case"date":this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return e===t}),this.emit("validator.add",e);break;default:console.warn("No validator could be create for %c"+e+"%c. The validator appears to be invalid.",NGN.css,"")}}},{key:"removeValidator",value:function(e){this.validators.hasOwnProperty(e)&&(delete this.validators[e],this.emit("validator.remove",e))}},{key:"validate",value:function(e){var t=this;if(e){if(this.validators.hasOwnProperty(e)){for(var i=0;i<this.validators[e].length;i++){if(!t.validators[e][i](t[e]))return t.invalidDataAttributes.indexOf(e)<0&&t.invalidDataAttributes.push(e),!1;t.invalidDataAttributes=t.invalidDataAttributes.filter(function(t){return e!==t})}if(!this.validateDataType(e))return this.invalidDataAttributes.push(e),!1}return!0}this.datafields.forEach(function(e){t.validate(e)})}},{key:"validateDataType",value:function(e){var t=NGN["typeof"](this[e]),i=NGN["typeof"](this.fields[e].type);return"null"!==t?t===i:null!==this[e]||!this.fields[e].required||!(!this.autoid||e!==this.idAttribute)}},{key:"getRelationshipField",value:function(e){return this.joins[e]}},{key:"hasRelationship",value:function(e){return this.joins.hasOwnProperty(e)}},{key:"getDataField",value:function(e){return this.fields[e]}},{key:"hasDataField",value:function(e){return this.fields.hasOwnProperty(e)}},{key:"serialize",value:function(e){var t=e||this.raw,i={};for(var a in t)if(t.nonEnumerableProperties=t.nonEnumerableProperties||"",this.fields.hasOwnProperty(a)&&(a="id"===a?this.idAttribute:a,t.hasOwnProperty(a)&&t.nonEnumerableProperties.indexOf(a)<0&&/^[a-z0-9 ]$/.test(a.substr(0,1))||void 0!==t[a]&&t.enumerableProperties.indexOf(a)>=0)){var r=Object.getOwnPropertyDescriptor(t,a);if(!r.set)switch(_typeof(r.value)){case"function":"Date"===r.value.name?i[a]=t[a].refs.toJSON():"RegExp"===r.value.name&&(i[a]=r.value());break;case"object":t[a]instanceof Array&&!Array.isArray(t[a])&&(t[a]=t[a].slice(0)),i[a]=t[a];break;default:i[a]=t[a]}}var n=this;return this.relationships.forEach(function(e){i[e]=n.rawjoins[e].data}),i}},{key:"addField",value:function addField(field,fieldcfg,suppressEvents){"boolean"==typeof fieldcfg&&(suppressEvents=fieldcfg,fieldcfg=null),suppressEvents=void 0!==suppressEvents&&suppressEvents;var me=this,cfg=null;if("id"!==field.toLowerCase()){if("object"===("undefined"==typeof field?"undefined":_typeof(field))){if(!field.name)throw new Error("Cannot create data field. The supplied configuration does not contain a unique data field name.");cfg=field,field=cfg.name,delete cfg.name}if(void 0!==me[field]){try{var source=NGN.stack.pop();console.warn("%c"+field+"%c data field defined multiple times (at %c"+source.path+"%c). Only the last defintion will be used.",NGN.css,"",NGN.css,"")}catch(e){console.warn("%c"+field+"%c data field defined multiple times. Only the last definition will be used.",NGN.css,"",NGN.css,"")}delete me[field]}if(me.fields[field]=cfg||me.fields[field]||{},me.fields[field].required=NGN.coalesce(me.fields[field].required,!1),!me.fields[field].hasOwnProperty("type")&&me.fields[field].hasOwnProperty("default")){var type=NGN["typeof"](me.fields[field]["default"]);type=type.charAt(0).toUpperCase()+type.slice(1),me.fields[field].type=eval(type)}if(me.fields[field].type=NGN.coalesce(me.fields[field].type,String),field===me.idAttribute&&me.autoid===!0?(me.fields[field].type=String,me.fields[field]["default"]=NGN.DATA.util.GUID()):me.fields[field]["default"]=me.fields[field]["default"]||null,me.raw[field]=me.fields[field]["default"],me[field]=me.raw[field],Object.defineProperty(me,field,{get:function(){return me.raw[field]},set:function(e){var t=me.raw[field];me.raw[field]=e;var i={action:"update",field:field,old:t,"new":me.raw[field]};this.changelog.push(i),this.emit("field.update",i),this.emit("field.update."+field,i),me.validate(field)||me.emit("field.invalid",{field:field})}}),!suppressEvents){var c={action:"create",field:field};this.changelog.push(c),this.emit("field.create",c)}if(me.fields.hasOwnProperty(field)&&(me.fields[field].hasOwnProperty("pattern")&&me.addValidator(field,me.fields[field].pattern),["min","max","enum"].forEach(function(e){me.fields[field].hasOwnProperty(e)&&me.addValidator(field,function(t){return me._nativeValidators[e](me.fields[field][e],t)})}),me.fields[field].hasOwnProperty("required")&&me.fields[field].required&&me.addValidator(field,function(e){return me._nativeValidators.required(field,e)}),me.fields[field].hasOwnProperty("validate")))if("function"==typeof me.fields[field])me.addValidator(field,function(e){return me.fields[field](e)});else{var _source=NGN.stack.pop();console.warn("Invalid custom validation function (in %c"+_source.path+"%c). The value passed to the validate attribute must be a function.",NGN.css,"")}}else null===me.id&&me.autoid&&(me.id=NGN.DATA.util.GUID())}},{key:"addVirtual",value:function(e,t){var i=this;Object.defineProperty(this,e,{get:function(){return t.apply(i)}})}},{key:"addRelationshipField",value:function(e,t,i){if(i=void 0!==i&&i,this.rawjoins.hasOwnProperty(e)||this.fields.hasOwnProperty(e)||this.hasOwnProperty(e))throw new Error(e+" already exists. It cannot be added to the model again.");if(("function"==typeof t||"object"===("undefined"==typeof t?"undefined":_typeof(t))&&!t.hasOwnProperty("type"))&&(t={type:t}),!t.type)throw new Error("Configuration has no reference! The reference must be an NGN.DATA.Model or NGN.DATA.Store.");t.required=NGN.coalesce(t.required,!0),t["default"]=t["default"]||null;var a=this,r="model";if(t.type instanceof NGN.DATA.Store)r="store";else if("array"===NGN["typeof"](t.type)){if(0===t.type.length)throw new Error(e+" cannot be an empty store. A model must be provided.");r="collection"}else"object"===_typeof(t.type)&&t.type.model&&(r="store");if("store"===r){var n={};if(t.type instanceof NGN.DATA.Store)this.rawjoins[e]=t.type,n=null;else{if(!t.type.model)throw new Error("Nested store configuration is invalid or was not recognized.");n=t.type}null!==n&&(this.rawjoins[e]=new NGN.DATA.Store(n)),this.applyStoreMonitor(e)}else if("collection"===r)this.rawjoins[e]=new NGN.DATA.Store({model:t.type[0]}),this.applyStoreMonitor(e);else if(t.type.data){if(!t.type.data)throw new Error("Nested store configuration is invalid or was not recognized.");this.rawjoins[e]=t.type,this.applyStoreMonitor(e)}else this.rawjoins[e]=null!==t["default"]?new t.type(t["default"]):new t.type,this.applyModelMonitor(e);if(Object.defineProperty(this,e,{enumerable:!0,get:function(){return a.rawjoins[e]}}),!i){var o={action:"create",field:e};this.changelog.push(o),this.emit("relationship.create",o)}}},{key:"applyModelMonitor",value:function(e){var t=this.rawjoins[e],i=this;t.on("field.update",function(a){var r={action:"update",field:e+"."+a.field,old:a.old,"new":a["new"],join:!0,originalEvent:{event:"field.update",record:t}};i.emit("field.update",r),i.emit("field.update."+e+"."+a.field,r)}),t.on("field.create",function(a){var r={action:"update",field:e+"."+a.field,old:null,"new":null,join:!0,originalEvent:{event:"field.create",record:t}};i.emit("field.update",r),i.emit("field.update."+e+"."+a.field,r)}),t.on("field.remove",function(a){var r={action:"update",field:e+"."+a.field,old:a.value,"new":null,join:!0,originalEvent:{event:"field.remove",record:t}};i.emit("field.update",r),i.emit("field.update."+e+"."+a.field,r)})}},{key:"applyStoreMonitor",value:function(e){var t=this;this.rawjoins.hasOwnProperty(e)&&this.rawjoins[e].hasOwnProperty("proxy")&&!function(){var i=t;t.rawjoins[e].on("record.create",function(t){var a=i[e].data;a.pop();var r={action:"update",field:e,join:!0,old:a,"new":i[e].data,originalEvent:{event:"record.create",record:t}};i.emit("field.update",r),i.emit("field.update."+e,r)}),t.rawjoins[e].on("record.update",function(t,a){if(a){var r={action:"update",field:e+"."+a.field,join:!0,old:a.old,"new":a["new"],originalEvent:{event:"record.update",record:t}};i.emit("field.update",r),i.emit("field.update."+e+"."+a.field,r)}}),t.rawjoins[e].on("record.delete",function(t){var a=i[e].data;a.push(t.data);var r={action:"update",field:e,join:!0,old:a,"new":i[e].data,originalEvent:{event:"record.delete",record:t}};i.emit("field.update",r),i.emit("field.update."+e,r)})}()}},{key:"removeField",value:function(e){if(this.raw.hasOwnProperty(e)){var t=this.raw[e];delete this[e],delete this.fields[e],delete this.raw[e],this.invalidDataAttributes.indexOf(e)>=0&&this.invalidDataAttributes.splice(this.invalidDataAttributes.indexOf(e),1);var i={action:"delete",field:e,value:t};this.emit("field.remove",i),this.changelog.push(i)}}},{key:"removeVirtual",value:function(e){delete this[e]}},{key:"removeRelationshipField",value:function(e,t){if(t=void 0!==t&&t,this.joins.hasOwnProperty(e)){var i=this.rawjoins[e];if(delete this.rawjoins[e],delete this[e],delete this.joins[e],!t){var a={action:"delete",field:e,old:i,join:!0};this.changelog.push(a),this.emit("relationship.remove",a)}}}},{key:"undo",value:function(e){e=e||1;var t=this.changelog.splice(this.changelog.length-e,e),i=this;t.reverse().forEach(function(e){if("boolean"==typeof e.join&&e.join)switch(e.action){case"create":i.removeRelationshipField(e.field);break;case"delete":i.addRelationshipField(e.field),i[e.field]=e.old}else switch(e.action){case"update":i[e.field]=e.old;break;case"create":i.removeField(e.field);break;case"delete":i.addField(e.field),i[e.field]=i.old}})}},{key:"load",value:function(e){e=e||{};var t=this;null!==this._dataMap&&Object.keys(this.reverseMap).forEach(function(i){e.hasOwnProperty(i)&&(e[t.reverseMap[i]]=e[i],delete e[i])}),Object.keys(e).forEach(function(i){if(t.fields.hasOwnProperty(i))t.raw.hasOwnProperty(i)?t.raw[i]=e[i]:i===t.idAttribute&&(t.id=e[i]);else if(t.joins.hasOwnProperty(i))t.rawjoins[i].load(e[i]);else try{var a=NGN.stack.pop();console.warn("%c"+i+"%c specified in %c"+a.path+"%c as a data field but is not defined in the model.",NGN.css,"",NGN.css,"")}catch(r){console.warn("%c"+i+"%c specified as a data field but is not defined in the model.",NGN.css,"")}}),this.setUnmodified()}},{key:"expires",get:function(){return this.expiration},set:function(e){var t=this;if("date"===NGN["typeof"](e)||"number"===NGN["typeof"](e)){if(clearTimeout(this.expirationTimeout),"number"===NGN["typeof"](e)){if(e<0)return void(this.ignoreTTL=!0);var i=new Date;e=new Date(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i.getMilliseconds()+e)}if(this.ignoreTTL=!1,this.expiration=e,Date.now()>=this.expiration.getTime())return void this.expire();this.hasExpired=!1;var a=this.expiration.getTime()-Date.now();this.expirationTimeout=setTimeout(function(){t.expire()},a)}else try{var r=NGN.stack.pop();console.warn("Expiration could not be set at %c"+r.path+"%c (Invalid data type. Must be a Date or number).",NGN.css,"")}catch(n){console.warn("Expiration could not be set (Invalid data type. Must be a Date or number).")}}},{key:"expired",get:function(){return!this.ignoreTTL&&this.hasExpired}},{key:"modified",get:function(){return this.checksum!==this.benchmark}},{key:"id",get:function(){return this.oid},set:function(e){this.oid=e}},{key:"checksum",get:function(){return NGN.DATA.util.checksum(JSON.stringify(this.data))}},{key:"dataMap",get:function(){return this._dataMap},set:function(e){this._dataMap=e,this._reverseDataMap=null}},{key:"datastore",get:function(){return this._store}},{key:"valid",get:function(){return this.validate(),0===this.invalidDataAttributes.length}},{key:"datafields",get:function(){return Object.keys(this.fields)}},{key:"relationships",get:function(){return Object.keys(this.joins)}},{key:"virtualdatafields",get:function(){return Object.keys(this.virtuals)}},{key:"reverseMap",get:function(){var e=this;if(null!==this.dataMap){var t=function(){if(null!==e._reverseDataMap)return{v:e._reverseDataMap};var t={},i=e;return Object.keys(e._dataMap).forEach(function(e){t[i._dataMap[e]]=e}),e._reverseDataMap=t,{v:t}}();if("object"===("undefined"==typeof t?"undefined":_typeof(t)))return t.v}return null}},{key:"data",get:function(){var e=this,t=this.serialize();return!t.hasOwnProperty(this.idAttribute)&&this.autoid&&(t[this.idAttribute]=this[this.idAttribute]),this.dataMap&&!function(){var i=e;Object.keys(e.dataMap).forEach(function(e){t.hasOwnProperty(e)&&(t[e]instanceof NGN.DATA.Model?t[i.dataMap[e]]=t[e].data:t[i.dataMap[e]]=t[e],delete t[e])})}(),t}},{key:"history",get:function(){return this.changelog.reverse()}}]),Model}(NGN.EventEmitter);NGN.DATA=NGN.DATA||{},Object.defineProperties(NGN.DATA,{Model:NGN["public"](function(e){var t=function(t){var i=new Model(e);return t&&i.load(t),i};return t}),Entity:NGN["private"](Model)}),NGN.nodelike&&(module.exports=NGN.DATA);
//# sourceMappingURL=https://ngnjs.github.io/cdn/assets/chassis-lib/sourcemaps/1.0.113/model.min.js.map