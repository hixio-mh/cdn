/**
  * v1.0.84 generated on: Wed Jul 06 2016 16:37:25 GMT+0000 (UTC)
  * Copyright (c) 2014-2016, Ecor Ventures LLC. All Rights Reserved. See LICENSE (BSD).
  */
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),Model=function(e){function t(e){_classCallCheck(this,t),e=e||{};var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this)),a=i;Object.defineProperties(i,{idAttribute:NGN.privateconst(e.idAttribute||"id"),fields:NGN["private"](e.fields||{id:{required:!0,type:String,"default":e.id||null}}),joins:NGN["private"](e.relationships||{}),virtuals:NGN["private"](e.virtuals||{}),validators:NGN["private"]({}),validation:NGN["public"](NGN.coalesce(e.validation,!0)),isNew:NGN["private"](!0),isDestroyed:NGN["private"](!1),oid:NGN["private"](e[i.idAttribute]||null),autoid:NGN["public"](NGN.coalesce(e.autoid,!1)),benchmark:NGN["private"](null),setUnmodified:NGN.privateconst(function(){this.benchmark=this.checksum,this.changelog=[]}),allowInvalidSave:NGN["private"](NGN.coalesce(e.allowInvalidSave,!1)),disableDataValidation:NGN["private"](NGN.coalesce(e.disableDataValidation,!1)),invalidDataAttributes:NGN["private"]([]),initialDataAttributes:NGN["private"]([]),changelog:NGN["private"]([]),_nativeValidators:NGN.privateconst({min:function(e,t){return t instanceof Array?t.length>=e:t instanceof Number?t>=e:t instanceof String?t.trim().length>=e:t instanceof Date&&t.parse()>=e.parse()},max:function(e,t){return t instanceof Array?t.length<=e:t instanceof Number?t<=e:t instanceof String?t.trim().length<=e:t instanceof Date&&t.parse()<=e.parse()},"enum":function(e,t){return e.indexOf(t)>=0},required:function(e){return this.hasOwnProperty(e)}}),_dataMap:NGN["private"](e.dataMap||null),_reverseDataMap:NGN["public"](null),raw:NGN["private"]({}),rawjoins:NGN["private"]({}),_store:NGN["private"](null)});var r=i.datafields.concat(i.virtualdatafields).concat(i.relationships).filter(function(e,t,i){return i.indexOf(e)!==t});if(r.length>0)throw new Error("Duplicate field names exist: "+r.join(", ")+". Unique fieldnames are required for data fields, virtuals, and relationship fields.");i.fields.hasOwnProperty("id")||(e.fields.id={required:!0,type:String,"default":e.id||null}),Object.keys(i.fields).forEach(function(e){a.addField(e,!0)}),Object.keys(i.virtuals).forEach(function(e){Object.defineProperty(a,e,NGN.get(function(){return a.virtuals[e].apply(a)}))}),Object.keys(i.joins).forEach(function(e){a.addRelationshipField(e,a.joins[e],!0)});var n=["field.update","field.create","field.remove","field.invalid","validator.add","validator.remove","relationship.create","relationship.remove"];return NGN.BUS&&n.forEach(function(e){a.on(e,function(){var t=NGN.slice(arguments);t.push(a),t.unshift(e),NGN.BUS.emit.apply(NGN.BUS,t)})}),i}return _inherits(t,e),_createClass(t,[{key:"addValidator",value:function(e,t){if(!this.hasOwnProperty(e))return void console.warn("No validator could be create for "+e.toUpperCase()+". It is not an attribute of "+this.type.toUpperCase()+".");switch("undefined"==typeof t?"undefined":_typeof(t)){case"function":this.validators[e]=this.validators[e]||[],this.validators[e].push(t),this.emit("validator.add",e);break;case"object":Array.isArray(t)?(this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return t.indexOf(e)>=0}),this.emit("validator.add",e)):t.test?(this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return t.test(e)}),this.emit("validator.add",e)):console.warn("No validator could be created for "+e.toUpperCase()+". The validator appears to be invalid.");break;case"string":case"number":case"date":this.validators[e]=this.validators[e]||[],this.validators[e].push(function(e){return e===t}),this.emit("validator.add",e);break;default:console.warn("No validator could be create for "+e.toUpperCase()+". The validator appears to be invalid.")}}},{key:"removeValidator",value:function(e){this.validators.hasOwnProperty(e)&&(delete this.validators[e],this.emit("validator.remove",e))}},{key:"validate",value:function(e){var t=!0,i=this;if(e&&this.validators.hasOwnProperty(e)){for(var a=0;a<this.validators[e].length;a++)if(!i.validators[e][a](i[e]))return i.invalidDataAttributes.indexOf(e)<0&&i.invalidDataAttributes.push(e),!1;return!0}for(var r in this.validators)if(this[r]&&this.validators.hasOwnProperty(r)){for(var n=!0,o=0;o<this.validators[r].length&&(n=this.validators[r][o](this[r]));o++);!n&&this.invalidDataAttributes.indexOf(r)<0&&this.invalidDataAttributes.push(r),t&&!n&&(t=!1)}return!0}},{key:"getRelationshipField",value:function(e){return this.joins[e]}},{key:"hasRelationship",value:function(e){return this.joins.hasOwnProperty(e)}},{key:"getDataField",value:function(e){return this.fields[e]}},{key:"hasDataField",value:function(e){return this.fields.hasOwnProperty(e)}},{key:"serialize",value:function(e){var t=e||this.raw,i={};for(var a in t)if(t.nonEnumerableProperties=t.nonEnumerableProperties||"",this.fields.hasOwnProperty(a)&&(a="id"===a?this.idAttribute:a,t.hasOwnProperty(a)&&t.nonEnumerableProperties.indexOf(a)<0&&/^[a-z0-9 ]$/.test(a.substr(0,1))||void 0!==t[a]&&t.enumerableProperties.indexOf(a)>=0)){var r=Object.getOwnPropertyDescriptor(t,a);if(!r.set)switch(_typeof(r.value)){case"function":"Date"===r.value.name?i[a]=t[a].refs.toJSON():"RegExp"===r.value.name&&(i[a]=r.value());break;case"object":t[a]instanceof Array&&!Array.isArray(t[a])&&(t[a]=t[a].slice(0)),i[a]=t[a];break;default:i[a]=t[a]}}var n=this;return this.relationships.forEach(function(e){i[e]=n[e].data}),i}},{key:"addField",value:function(e,t,i){"boolean"==typeof t&&(i=t,t=null),i=void 0!==i&&i;var a=this,r=null;if("id"!==e.toLowerCase()){if("object"===("undefined"==typeof e?"undefined":_typeof(e))){if(!e.name)throw new Error("Cannot create data field. The supplied configuration does not contain a unique data field name.");r=e,e=r.name,delete r.name}if(void 0!==a[e]&&(console.warn(e+" data field defined multiple times. Only the last defintion will be used."),delete a[e]),a.fields[e]=r||a.fields[e]||{},a.fields[e].required=NGN.coalesce(a.fields[e].required,!1),a.fields[e].type=NGN.coalesce(a.fields[e].type,String),e===a.idAttribute&&a.autoid===!0?(a.fields[e].type=String,a.fields[e]["default"]=NGN.DATA.util.GUID()):a.fields[e]["default"]=a.fields[e]["default"]||null,a.raw[e]=a.fields[e]["default"],a[e]=a.raw[e],Object.defineProperty(a,e,{get:function(){return a.raw[e]},set:function(t){var i=a.raw[e];a.raw[e]=t;var r={action:"update",field:e,old:i,"new":a.raw[e]};this.changelog.push(r),this.emit("field.update",r),a.validate(e)||a.emit("field.invalid",{field:e})}}),!i){var n={action:"create",field:e};this.changelog.push(n),this.emit("field.create",n)}a.fields.hasOwnProperty(e)&&(a.fields[e].hasOwnProperty("pattern")&&a.addValidator(e,a.fields[e].pattern),["min","max","enum"].forEach(function(t){a.fields[e].hasOwnProperty(t)&&a.addValidator(e,function(i){return a._nativeValidators[t](a.fields[e],i)})}),a.fields[e].hasOwnProperty("required")&&a.fields[e].required&&a.addValidator(e,function(e){return a._nativeValidators.required(e)}),a.fields[e].hasOwnProperty("validate")&&("function"==typeof a.fields[e]?a.addValidator(e,function(t){return a.fields[e](t)}):console.warn("Invalid custom validation function. The value passed to the validate attribute must be a function.")))}else null===a.id&&a.autoid&&(a.id=NGN.DATA.util.GUID())}},{key:"addVirtual",value:function(e,t){var i=this;Object.defineProperty(this,e,{get:function(){return t.apply(i)}})}},{key:"addRelationshipField",value:function(e,t,i){if(i=void 0!==i&&i,this.rawjoins.hasOwnProperty(e)||this.fields.hasOwnProperty(e)||this.hasOwnProperty(e))throw new Error(e+" already exists. It cannot be added to the model again.");if(("function"==typeof t||"object"===("undefined"==typeof t?"undefined":_typeof(t))&&!t.hasOwnProperty("type"))&&(t={type:t}),!t.type)throw new Error("Configuration has no reference! The reference must be an NGN.DATA.Model or NGN.DATA.Store.");t.required=NGN.coalesce(t.required,!0),t["default"]=t["default"]||null;var a=this,r="model";if(t.type instanceof NGN.DATA.Store?r="store":"object"===_typeof(t.type)&&t.type.model&&(r="store"),"store"===r){var n={};if(t.type instanceof NGN.DATA.Store)return void(this.rawjoins[e]=t.type);if(!t.type.model)throw new Error("Nested store configuration is invalid or was not recognized.");n=t.type,this.rawjoins[e]=new NGN.DATA.Store(n),this.applyStoreMonitor(e)}else if(t.type.data){if(!t.type.data)throw new Error("Nested store configuration is invalid or was not recognized.");this.rawjoins[e]=t.type,this.applyStoreMonitor(e)}else this.rawjoins[e]=null!==t["default"]?new t.type(t["default"]):new t.type,this.applyModelMonitor(e);if(Object.defineProperty(this,e,{enumerable:!0,get:function(){return a.rawjoins[e]}}),!i){var o={action:"create",field:e};this.changelog.push(o),this.emit("relationship.create",o)}}},{key:"applyModelMonitor",value:function(e){var t=this.rawjoins[e],i=this;t.on("field.update",function(t){i.emit("field.update",{action:"update",field:e+"."+t.field,old:t.old,"new":t["new"],join:!0})}),t.on("field.create",function(t){i.emit("field.update",{action:"update",field:e+"."+t.field,old:null,"new":null,join:!0})}),t.on("field.remove",function(t){i.emit("field.update",{action:"update",field:e+"."+t.field,old:t.value,"new":null,join:!0})})}},{key:"applyStoreMonitor",value:function(e){var t=this;this.rawjoins.hasOwnProperty(e)&&this.rawjoins[e].hasOwnProperty("proxy")&&!function(){var i=t;t.rawjoins[e].on("record.create",function(t){var a=i[e].data;a.pop();var r={action:"update",field:e,join:!0,old:a,"new":i[e].data};i.emit("field.update",r)}),t.rawjoins[e].on("record.update",function(t,a){if(a){var r={action:"update",field:e+"."+a.field,join:!0,old:a.old,"new":a["new"]};i.emit("field.update",r)}}),t.rawjoins[e].on("record.delete",function(t){var a=i[e].data;a.push(t.data);var r={action:"update",field:e,join:!0,old:a,"new":i[e].data};i.emit("field.update",r)})}()}},{key:"removeField",value:function(e){if(this.raw.hasOwnProperty(e)){var t=this.raw[e];delete this[e],delete this.fields[e],delete this.raw[e],this.invalidDataAttributes.indexOf(e)>=0&&this.invalidDataAttributes.splice(this.invalidDataAttributes.indexOf(e),1);var i={action:"delete",field:e,value:t};this.emit("field.remove",i),this.changelog.push(i)}}},{key:"removeVirtual",value:function(e){delete this[e]}},{key:"removeRelationshipField",value:function(e,t){if(t=void 0!==t&&t,this.joins.hasOwnProperty(e)){var i=this.rawjoins[e];if(delete this.rawjoins[e],delete this[e],delete this.joins[e],!t){var a={action:"delete",field:e,old:i,join:!0};this.changelog.push(a),this.emit("relationship.remove",a)}}}},{key:"undo",value:function(e){e=e||1;var t=this.changelog.splice(this.changelog.length-e,e),i=this;t.reverse().forEach(function(e){if("boolean"==typeof e.join&&e.join)switch(e.action){case"create":i.removeRelationshipField(e.field);break;case"delete":i.addRelationshipField(e.field),i[e.field]=e.old}else switch(e.action){case"update":i[e.field]=e.old;break;case"create":i.removeField(e.field);break;case"delete":i.addField(e.field),i[e.field]=i.old}})}},{key:"load",value:function(e){e=e||{};var t=this;null!==this._dataMap&&Object.keys(this.reverseMap).forEach(function(i){e.hasOwnProperty(i)&&(e[t.reverseMap[i]]=e[i],delete e[i])}),Object.keys(e).forEach(function(i){if(t.fields.hasOwnProperty(i))t.raw.hasOwnProperty(i)?t.raw[i]=e[i]:i===t.idAttribute&&(t.id=e[i]);else if(t.joins.hasOwnProperty(i)){var a=new t.getRelated(i).type();a.load(e[i]),t.rawjoin[i]=a}else console.warn(i+" was specified as a data field but is not defined in the model.")}),this.setUnmodified()}},{key:"modified",get:function(){return this.checksum!==this.benchmark}},{key:"id",get:function(){return this.oid},set:function(e){this.oid=e}},{key:"checksum",get:function(){return NGN.DATA.util.checksum(JSON.stringify(this.data))}},{key:"dataMap",get:function(){return this._dataMap},set:function(e){this._dataMap=e,this._reverseDataMap=null}},{key:"datastore",get:function(){return this._store}},{key:"valid",get:function(){return 0===this.invalidDataAttributes.length}},{key:"datafields",get:function(){return Object.keys(this.fields)}},{key:"relationships",get:function(){return Object.keys(this.joins)}},{key:"virtualdatafields",get:function(){return Object.keys(this.virtuals)}},{key:"reverseMap",get:function(){var e=this;if(null!==this.dataMap){var t=function(){if(null!==e._reverseDataMap)return{v:e._reverseDataMap};var t={},i=e;return Object.keys(e._dataMap).forEach(function(e){t[i._dataMap[e]]=e}),e._reverseDataMap=t,{v:t}}();if("object"===("undefined"==typeof t?"undefined":_typeof(t)))return t.v}return null}},{key:"data",get:function(){var e=this,t=this.serialize();return!t.hasOwnProperty(this.idAttribute)&&this.autoid&&(t[this.idAttribute]=this[this.idAttribute]),this.dataMap&&!function(){var i=e;Object.keys(e.dataMap).forEach(function(e){t.hasOwnProperty(e)&&(t[e]instanceof NGN.DATA.Model?t[i.dataMap[e]]=t[e].data:t[i.dataMap[e]]=t[e],delete t[e])})}(),t}},{key:"history",get:function(){return this.changelog.reverse()}}]),t}(NGN.EventEmitter);NGN.DATA=NGN.DATA||{},Object.defineProperties(NGN.DATA,{Model:NGN["public"](function(e){var t=function(t){var i=new Model(e);return t&&i.load(t),i};return t}),Entity:NGN["private"](Model)}),NGN.nodelike&&(module.exports=NGN.DATA);
//# sourceMappingURL=https://ngnjs.github.io/cdn/assets/chassis-lib/sourcemaps/model.min.js.map